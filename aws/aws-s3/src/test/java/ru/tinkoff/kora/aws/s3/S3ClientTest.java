package ru.tinkoff.kora.aws.s3;

import io.minio.GetObjectArgs;
import io.minio.MakeBucketArgs;
import io.minio.MinioClient;
import io.minio.PutObjectArgs;
import io.minio.errors.ErrorResponseException;
import org.junit.jupiter.api.*;
import org.mockito.Mockito;
import org.testcontainers.containers.GenericContainer;
import org.testcontainers.utility.DockerImageName;
import ru.tinkoff.kora.aws.s3.exception.S3ClientErrorException;
import ru.tinkoff.kora.aws.s3.exception.S3ClientResponseException;
import ru.tinkoff.kora.aws.s3.impl.S3ClientImpl;
import ru.tinkoff.kora.aws.s3.model.RangeData;
import ru.tinkoff.kora.http.client.ok.OkHttpClient;

import java.io.ByteArrayInputStream;
import java.nio.charset.StandardCharsets;
import java.time.Duration;
import java.util.Arrays;
import java.util.List;
import java.util.UUID;
import java.util.concurrent.ThreadLocalRandom;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.assertThatThrownBy;
import static org.mockito.Mockito.mock;
import static org.mockito.Mockito.when;

class S3ClientTest {
    static GenericContainer<?> minio = new GenericContainer<>(DockerImageName.parse("minio/minio"))
        .withCommand("server", "/home/shared")
        .withEnv("SERVICES", "s3")
        .withStartupTimeout(Duration.ofMinutes(1))
        .withNetworkAliases("s3")
        .withExposedPorts(9000);
    static okhttp3.OkHttpClient ok = new okhttp3.OkHttpClient.Builder()
//        .addInterceptor(new HttpLoggingInterceptor(System.out::println).setLevel(HttpLoggingInterceptor.Level.HEADERS))
        .build();
    static MinioClient minioClient;

    AwsCredentials credentials = AwsCredentials.of("minioadmin", "minioadmin");
    AwsCredentials invalidCredentials = AwsCredentials.of("test", "test");
    S3Config config;

    @BeforeAll
    static void beforeAll() throws Exception {
        minio.start();
        minioClient = MinioClient.builder()
            .httpClient(ok)
            .endpoint("http://" + minio.getHost() + ":" + minio.getMappedPort(9000))
//            .endpoint("http://localhost:4444")
            .credentials("minioadmin", "minioadmin")
            .build();
        minioClient.makeBucket(MakeBucketArgs.builder()
            .bucket("test")
            .build());
    }

    @AfterAll
    static void afterAll() {
        minio.stop();
    }


    @BeforeEach
    void setUp() {
        this.config = mock(S3Config.class);
        when(config.endpoint()).thenReturn("http://" + minio.getHost() + ":" + minio.getMappedPort(9000));
//        when(config.endpoint()).thenReturn("http://localhost:4444");
        when(config.addressStyle()).thenReturn(S3Config.AddressStyle.PATH);
        when(config.region()).thenReturn("us-east-1");
        when(config.upload()).thenReturn(Mockito.mock());
        when(config.upload().singlePartUploadLimit()).thenCallRealMethod();
        when(config.upload().chunkSize()).thenCallRealMethod();
        when(config.upload().partSize()).thenCallRealMethod();
    }

    S3Client s3Client(String accessKey, String secretKey) {

        var httpClient = new OkHttpClient(ok);
        return new S3ClientImpl(httpClient, config);
    }

    S3Client s3Client() {
        return s3Client("minioadmin", "minioadmin");
    }

    @Nested
    class HeadObject {

        @Test
        void testHeadObjectThrowsErrorOnUnknownObject() throws Exception {
            assertThatThrownBy(() -> s3Client().headObject(credentials, "test", UUID.randomUUID().toString()))
                .isInstanceOf(S3ClientErrorException.class)
                .hasFieldOrPropertyWithValue("errorCode", "NoSuchKey")
                .hasFieldOrPropertyWithValue("errorMessage", "Object does not exist");
        }

        @Test
        void testHeadObjectThrowsErrorOnUnknownBucket() throws Exception {
            // HEAD throws 404 without a body (because HEAD has no body), so we cannot read code and message and detect if it's no bucket or no key
            assertThatThrownBy(() -> s3Client().headObject(credentials, UUID.randomUUID().toString(), UUID.randomUUID().toString()))
                .isInstanceOf(S3ClientErrorException.class)
                .hasFieldOrPropertyWithValue("errorCode", "NoSuchKey")
                .hasFieldOrPropertyWithValue("errorMessage", "Object does not exist");
        }

        @Test
        void testHeadObjectForbidden() throws Exception {
            assertThatThrownBy(() -> s3Client().headObject(invalidCredentials, UUID.randomUUID().toString(), UUID.randomUUID().toString()))
                .isInstanceOf(S3ClientResponseException.class)
                .hasFieldOrPropertyWithValue("httpCode", 403);
        }

        @Test
        void testHeadObjectOptionalObjectReturnsNullOnUnknownObjects() {
            var object = s3Client().headObjectOptional(credentials, "test", UUID.randomUUID().toString());
            assertThat(object).isNull();
        }

        @Test
        void testHeadObjectOptionalObjectReturnsNullOnUnknownBucket() {
            var object = s3Client().headObjectOptional(credentials, UUID.randomUUID().toString(), UUID.randomUUID().toString());
            assertThat(object).isNull();
        }

        @Test
        void testHeadObjectdataValidObject() throws Exception {
            var key = UUID.randomUUID().toString();
            var content = UUID.randomUUID().toString().getBytes(StandardCharsets.UTF_8);
            minioClient.putObject(PutObjectArgs.builder()
                .bucket("test")
                .object(key)
                .contentType("text/plain")
                .stream(new ByteArrayInputStream(content), content.length, -1)
                .build());
            var metadata = s3Client().headObject(credentials, "test", key);
            assertThat(metadata).isNotNull();
            assertThat(metadata.bucket()).isEqualTo("test");
            assertThat(metadata.key()).isEqualTo(key);
            assertThat(metadata.size()).isEqualTo(content.length);
        }

        @Test
        void testGetOptionalMetadataValidObject() throws Exception {
            var key = UUID.randomUUID().toString();
            var content = UUID.randomUUID().toString().getBytes(StandardCharsets.UTF_8);
            minioClient.putObject(PutObjectArgs.builder()
                .bucket("test")
                .object(key)
                .contentType("text/plain")
                .stream(new ByteArrayInputStream(content), content.length, -1)
                .build());
            var metadata = s3Client().headObjectOptional(credentials, "test", key);
            assertThat(metadata).isNotNull();
            assertThat(metadata.bucket()).isEqualTo("test");
            assertThat(metadata.key()).isEqualTo(key);
            assertThat(metadata.size()).isEqualTo(content.length);
        }
    }

    @Nested
    class GetObject {
        @Test
        void testInvalidAccessKey() {
            assertThatThrownBy(() -> s3Client("test", "test").getObject(invalidCredentials, "test", UUID.randomUUID().toString(), null, true))
                .isInstanceOf(S3ClientErrorException.class)
                .hasFieldOrPropertyWithValue("errorCode", "InvalidAccessKeyId")
                .hasFieldOrPropertyWithValue("errorMessage", "The Access Key Id you provided does not exist in our records.");
        }

        @Test
        void testInvalidSecretKey() {
            assertThatThrownBy(() -> s3Client("minioadmin", "test").getObject(AwsCredentials.of("minioadmin", "test"), "test", UUID.randomUUID().toString(), null, true))
                .isInstanceOf(S3ClientErrorException.class)
                .hasFieldOrPropertyWithValue("errorCode", "SignatureDoesNotMatch")
                .hasFieldOrPropertyWithValue("errorMessage", "The request signature we calculated does not match the signature you provided. Check your key and signing method.");
        }

        @Test
        void testGetObjectThrowsErrorOnUnknownObject() {
            assertThatThrownBy(() -> s3Client().getObject(credentials, "test", UUID.randomUUID().toString(), null, true))
                .isInstanceOf(S3ClientErrorException.class)
                .hasFieldOrPropertyWithValue("errorCode", "NoSuchKey")
                .hasFieldOrPropertyWithValue("errorMessage", "The specified key does not exist.");
        }

        @Test
        void testGetObjectThrowsErrorOnUnknownBucket() {
            assertThatThrownBy(() -> s3Client().getObject(credentials, UUID.randomUUID().toString(), UUID.randomUUID().toString(), null, true))
                .isInstanceOf(S3ClientErrorException.class)
                .hasFieldOrPropertyWithValue("errorCode", "NoSuchBucket")
                .hasFieldOrPropertyWithValue("errorMessage", "The specified bucket does not exist");
        }

        @Test
        void testGetOptionalObjectReturnsNullOnUnknownObjects() {
            var object = s3Client().getObject(credentials, "test", UUID.randomUUID().toString(), null, false);
            assertThat(object).isNull();
        }

        @Test
        void testGetOptionalObjectReturnsNullOnUnknownBucket() {
            var object = s3Client().getObject(credentials, UUID.randomUUID().toString(), UUID.randomUUID().toString(), null, false);
            assertThat(object).isNull();
        }

        @Test
        void testGetValidObject() throws Exception {
            var key = UUID.randomUUID().toString();
            var content = UUID.randomUUID().toString().repeat(10240).getBytes(StandardCharsets.UTF_8);
            minioClient.putObject(PutObjectArgs.builder()
                .bucket("test")
                .object(key)
                .contentType("text/plain")
                .stream(new ByteArrayInputStream(content), content.length, -1)
                .build());
            try (var object = s3Client().getObject(credentials, "test", key, null, true)) {
                assertThat(object).isNotNull();
                try (var body = object.body()) {
                    assertThat(body.contentLength()).isEqualTo(content.length);
                    assertThat(body).isNotNull();
                    assertThat(body.asInputStream().readAllBytes()).isEqualTo(content);
                    assertThat(body.contentType()).isEqualTo("text/plain");
                }
            }
        }

        @Test
        void testGetRange() throws Exception {
            var key = UUID.randomUUID().toString();
            var content = UUID.randomUUID().toString().getBytes(StandardCharsets.UTF_8);
            minioClient.putObject(PutObjectArgs.builder()
                .bucket("test")
                .object(key)
                .contentType("text/plain")
                .stream(new ByteArrayInputStream(content), content.length, -1)
                .build());
            try (var object = s3Client().getObject(credentials, "test", key, new RangeData.Range(1, 5), true)) {
                assertThat(object).isNotNull();
                assertThat(object.contentRange().completeLength()).isEqualTo(content.length);
                try (var body = object.body()) {
                    assertThat(body.contentLength()).isEqualTo(5);
                    assertThat(body.asInputStream().readAllBytes()).isEqualTo(Arrays.copyOfRange(content, 1, 6));
                }
            }
            try (var object = s3Client().getObject(credentials, "test", key, new RangeData.StartFrom(5), true)) {
                assertThat(object).isNotNull();
                assertThat(object.contentRange().completeLength()).isEqualTo(content.length);
                try (var body = object.body()) {
                    assertThat(body.contentLength()).isEqualTo(content.length - 5);
                    assertThat(body.asInputStream().readAllBytes()).isEqualTo(Arrays.copyOfRange(content, 5, content.length));
                }
            }
            try (var object = s3Client().getObject(credentials, "test", key, new RangeData.LastN(5), true)) {
                assertThat(object).isNotNull();
                assertThat(object.contentRange().completeLength()).isEqualTo(content.length);
                try (var body = object.body()) {
                    assertThat(body.contentLength()).isEqualTo(5);
                    assertThat(body.asInputStream().readAllBytes()).isEqualTo(Arrays.copyOfRange(content, content.length - 5, content.length));
                }
            }
        }

        @Test
        void testGetOptionalValidObject() throws Exception {
            var key = UUID.randomUUID().toString();
            var content = UUID.randomUUID().toString().getBytes(StandardCharsets.UTF_8);
            minioClient.putObject(PutObjectArgs.builder()
                .bucket("test")
                .object(key)
                .contentType("text/plain")
                .stream(new ByteArrayInputStream(content), content.length, -1)
                .build());
            try (var object = s3Client().getObject(credentials, "test", key, null, false)) {
                assertThat(object).isNotNull();
                try (var body = object.body()) {
                    assertThat(body).isNotNull();
                    assertThat(body.contentLength()).isEqualTo(content.length);
                    assertThat(body.asInputStream().readAllBytes()).isEqualTo(content);
                    assertThat(body.contentType()).isEqualTo("text/plain");
                }
            }
        }

    }

    @Nested
    class DeleteObject {
        @Test
        void testDeleteObjectSuccessOnValidObject() throws Exception {
            var key = UUID.randomUUID().toString();
            var content = randomBytes(1024);
            minioClient.putObject(PutObjectArgs.builder()
                .bucket("test")
                .object(key)
                .contentType("text/plain")
                .stream(new ByteArrayInputStream(content), content.length, -1)
                .build());

            s3Client().deleteObject(credentials, "test", key);

            assertThatThrownBy(() -> minioClient.getObject(GetObjectArgs.builder()
                .bucket("test")
                .object(key)
                .build()))
                .isInstanceOf(ErrorResponseException.class)
                .extracting("errorResponse")
                .hasFieldOrPropertyWithValue("code", "NoSuchKey");
        }

        @Test
        void testDeleteObjectSuccessOnObjectThatDoesNotExist() throws Exception {
            var key = UUID.randomUUID().toString();

            s3Client().deleteObject(credentials, "test", key);
        }

        @Test
        void testDeleteObjectSuccessOnBucketThatDoesNotExist() throws Exception {
            var key = UUID.randomUUID().toString();

            s3Client().deleteObject(credentials, key, key);
        }

        @Test
        void testDeleteObjectAccessError() {
            var key = UUID.randomUUID().toString();
            assertThatThrownBy(() -> s3Client().deleteObject(invalidCredentials, key, key))
                .isInstanceOf(S3ClientResponseException.class)
                .hasFieldOrPropertyWithValue("httpCode", 403);
        }

        @Test
        void testDeleteObjects() throws Exception {
            var key1 = UUID.randomUUID().toString();
            var key2 = UUID.randomUUID().toString();
            var key3 = UUID.randomUUID().toString();
            var content = UUID.randomUUID().toString().getBytes(StandardCharsets.UTF_8);
            minioClient.putObject(PutObjectArgs.builder()
                .bucket("test")
                .object(key1)
                .contentType("text/plain")
                .stream(new ByteArrayInputStream(content), content.length, -1)
                .build());
            minioClient.putObject(PutObjectArgs.builder()
                .bucket("test")
                .object(key2)
                .contentType("text/plain")
                .stream(new ByteArrayInputStream(content), content.length, -1)
                .build());

            s3Client().deleteObjects(credentials, "test", List.of(key1, key2, key3));

            assertThatThrownBy(() -> minioClient.getObject(GetObjectArgs.builder()
                .bucket("test")
                .object(key1)
                .build()))
                .isInstanceOf(ErrorResponseException.class)
                .extracting("errorResponse")
                .hasFieldOrPropertyWithValue("code", "NoSuchKey");
            assertThatThrownBy(() -> minioClient.getObject(GetObjectArgs.builder()
                .bucket("test")
                .object(key2)
                .build()))
                .isInstanceOf(ErrorResponseException.class)
                .extracting("errorResponse")
                .hasFieldOrPropertyWithValue("code", "NoSuchKey");
            assertThatThrownBy(() -> minioClient.getObject(GetObjectArgs.builder()
                .bucket("test")
                .object(key3)
                .build()))
                .isInstanceOf(ErrorResponseException.class)
                .extracting("errorResponse")
                .hasFieldOrPropertyWithValue("code", "NoSuchKey");
        }
    }

    @Nested
    class Multipart {
        @Test
        void testCreateMultipartUpload() throws Exception {
            var prefix = UUID.randomUUID().toString();
            var key = UUID.randomUUID().toString();

            var uploadId = s3Client().createMultipartUpload(credentials, "test", prefix + "/" + key);
            assertThat(uploadId).isNotNull();
            try {
                var listResult = s3Client().listMultipartUploads(credentials, "test", null);

                assertThat(listResult.uploads()).hasSize(1);
                assertThat(listResult.uploads().getFirst().uploadId()).isEqualTo(uploadId);
                assertThat(listResult.uploads().getFirst().key()).isEqualTo(prefix + "/" + key);
            } finally {
                s3Client().abortMultipartUpload(credentials, "test", prefix + "/" + key, uploadId);
            }
        }

        @Test
        void testAbortMultipartUpload() throws Exception {
            var prefix = UUID.randomUUID().toString();
            var key = UUID.randomUUID().toString();

            var uploadId = s3Client().createMultipartUpload(credentials, "test", prefix + "/" + key);
            s3Client().abortMultipartUpload(credentials, "test", prefix + "/" + key, uploadId);

            var afterListResult = s3Client().listMultipartUploads(credentials, "test", null);

            assertThat(afterListResult.uploads()).isEmpty();
        }

        @Test
        void testUploadPart() {
            var key = UUID.randomUUID().toString();
            var content1 = randomBytes(1024 * 1024 * 8);
            var content2 = randomBytes(1024);

            var uploadId = s3Client().createMultipartUpload(credentials, "test", key);
            try {
                var etag1 = s3Client().uploadPart(credentials, "test", key, uploadId, 1, os -> os.write(content1), content1.length);
                assertThat(etag1).isNotNull();
                var etag2 = s3Client().uploadPart(credentials, "test", key, uploadId, 2, content2, 0, content2.length);
                assertThat(etag2).isNotNull();
            } finally {
                s3Client().abortMultipartUpload(credentials, "test", key, uploadId);
            }
        }

        @Test
        void testCompleteMultipartUpload() throws Exception {
            var key = UUID.randomUUID().toString();
            var content1 = randomBytes(1024 * 1024 * 8);
            var content2 = randomBytes(1024);

            var uploadId = s3Client().createMultipartUpload(credentials, "test", key);
            try {
                var etag1 = s3Client().uploadPart(credentials, "test", key, uploadId, 1, os -> os.write(content1), content1.length);
                var etag2 = s3Client().uploadPart(credentials, "test", key, uploadId, 2, content2, 0, content2.length);

                var etag = s3Client().completeMultipartUpload(credentials, "test", key, uploadId, List.of(etag1, etag2));
                assertThat(etag).isNotNull();

                try (var object = s3Client().getObject(credentials, "test", key);
                     var body = object.body();
                     var is = body.asInputStream()) {
                    var content = is.readAllBytes();
                    assertThat(content.length).isEqualTo(content1.length + content2.length);
                    assertThat(Arrays.copyOfRange(content, 0, content1.length)).isEqualTo(content1);
                    assertThat(Arrays.copyOfRange(content, content1.length, content.length)).isEqualTo(content2);
                }
            } finally {
                s3Client().abortMultipartUpload(credentials, "test", key, uploadId);
            }
        }

    }


    byte[] randomBytes(long len) {
        var bytes = new byte[Math.toIntExact(len)];
        ThreadLocalRandom.current().nextBytes(bytes);
        return bytes;
    }
}
